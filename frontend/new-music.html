<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>SpotiFIUBA</title>
        <link rel="stylesheet" href="styles/styles.css">
    </head>
    <body>
        <header>
            <div class="logo-spotifiuba" onclick="window.location.href='index.html'">
                <span class="negro">Spoti</span><span class="blanco">FIUBA</span><span class="tooltip">Ir a la Página Principal</span>
            </div>
        </header>
        <div class="input-login">
            <form id="form-musica">
                <div class="barra-input">
                    <label for="nombre">Nombre de la Música:</label>
                    <input type="text" id="nombre" name="nombre">
                </div>
                <div class="barra-input">
                    <label for="link_portada">Link a Imagen de Portada de la Música: - Opcional</label>
                    <input type="text" id="link_portada" name="link_portada">
                </div>
                <div class="barra-input">
                    <label for="artista">Nombre del Artista:</label>
                    <input type="text" id="artista" name="artista">
                </div>
                <div class="barra-input">
                    <label for="genero">Género de la Musica: - Seleccioná el que Mejor Describa la Música</label>
                    <select class="select-pagina" id="genero" name="genero">
                        <option value="Pop">Pop</option>
                        <option value="Rock">Rock</option>
                        <option value="Rap">Rap</option>
                        <option value="Musica Electronica">Música Electrónica</option>
                        <option value="R&B">R&B</option>
                        <option value="Reggaeton">Reggaetón</option>
                        <option value="Salsa">Salsa</option>
                        <option value="Jazz">Jazz</option>
                        <option value="Blues">Blues</option>
                        <option value="Heavy Metal">Heavy Metal</option>
                        <option value="Musica Clasica">Música Clásica</option>
                        <option value="Country">Country</option>
                        <option value="Bachata">Bachata</option>
                        <option value="Kpop">K-Pop</option>
                        <option value="Japonesa">Japonesa</option>
                    </select>
                </div>
                <div class="barra-input">
                    <label for="link_audio">Link a la Música: - Debe estar guardado en algo externo. Recomendacion: Cloudinary.</label>
                    <input type="text" id="link_audio" name="link_audio">
                </div>
                <div class = "boton-wrapper">
                    <button class= "boton-subir" type="submit">Subir Música</button>
                </div>
            </form>
        <script>
            const usuario = JSON.parse(localStorage.getItem("usuario"));
            const form = document.getElementById("form-musica");
            async function validarLogin(usuario) {
                
                if (!usuario) {
                    window.location.href = "index.html";
                    return;
                }

                try {
                    const res = await fetch(`http://localhost:3000/usuarios/${usuario.id}`)

                    if(!res.ok){
                        localStorage.clear();
                        window.location.href = "index.html";
                        return;
                    }

                } catch {
                    localStorage.clear();
                    window.location.href = "index.html";
                }
            }

            validarLogin(usuario);

            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const nombre = document.getElementById("nombre").value.trim();
                let link_portada = document.getElementById("link_portada").value.trim();
                if(link_portada === "") {
                    link_portada = null;
                }
                const artista = document.getElementById("artista").value.trim();
                const genero = document.getElementById("genero").value;
                const usuario_id = usuario.id;
                const link_audio = document.getElementById("link_audio").value.trim();

                if (!nombre || !artista || !genero || !link_audio) {
                    alert("Completa todos los campos obligatorios");
                    return;
                }

                try {
                    const respuesta = await fetch("http://localhost:3000/canciones", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ nombre, genero, artista, usuario_id, link_portada, link_audio})
                    });

                    if(!respuesta.ok) {
                        alert("Error al subir la música.");
                        return;
                    }
                    window.location.href = "lista-canciones.html"

                } catch {
                    alert("Error en la petición.")
                }
            })
        </script>
    </body>
</html>
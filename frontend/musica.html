<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>SpotiFIUBA</title>
        <link rel="stylesheet" href="styles/styles.css">
    </head>
    <body>
        <header>
            <div class="logo-spotifiuba" onclick="window.location.href='index.html'">
                <span class="negro">Spoti</span><span class="blanco">FIUBA</span><span class="tooltip">Ir a la PÃ¡gina Principal</span>
            </div>
        </header>

        <div class="contenedor-cancion">
            <img id="portada-musica" class="portada-musica">
            <h1 id="titulo-musica" class="titulo-musica"></h1>
            <div class="datos-musica">
                <p id="autor-musica">De: </p>
                <p id="usuario-musica">Subida Por: </p>
                <p id="genero-musica">Genero: </p>
            </div>
            <audio id="reproductor" controls></audio>
        </div>

        <div class="botones-musica" id="botones-musica">
            <button class="boton-subir" id="boton-editar">Editar Cancion</button>
            <button class="boton-borrar" id="boton-borrar">Borrar Cancion</button>
        </div>

        <script>
            const URLParametros = new URLSearchParams(window.location.search);
            const cancion_id = URLParametros.get("id");
            const usuarioLoggeado = JSON.parse(localStorage.getItem("usuario"));
            console.log(usuarioLoggeado.id);

            if(!cancion_id) {
                alert("Esa cancion no es valida.");
                window.location.href = "lista-canciones.html";
            }
            async function cargarMusica() {
                try {
                    const res = await fetch(`http://localhost:3000/canciones/${cancion_id}`);

                    if(!res.ok) {
                        alert("Esa cancion no existe.");
                        window.location.href = "lista-canciones.html";
                        return;
                    }

                    const cancion = await res.json();  
                    console.log(cancion.usuario_id)

                    const portadaMusica = document.getElementById("portada-musica");
                    const tituloMusica = document.getElementById("titulo-musica");
                    const autorMusica = document.getElementById("autor-musica");
                    const usuarioMusica = document.getElementById("usuario-musica");
                    const generoMusica = document.getElementById("genero-musica");
                    const reproductor = document.getElementById("reproductor");

                    portadaMusica.src = cancion.link_portada || 'https://i.pinimg.com/736x/b1/56/d8/b156d88727d0be3f16e79af15f66a122.jpg';
                    tituloMusica.textContent = cancion.nombre;
                    autorMusica.textContent = "De: " + cancion.artista;
                    usuarioMusica.textContent = "Subida Por: " + cancion.nombre_usuario;
                    generoMusica.textContent = "Genero: " + cancion.genero;
                    reproductor.src = cancion.link_audio;

                    if(usuarioLoggeado.id === cancion.usuario_id) {
                        document.getElementById("botones-musica").style.display = "flex";
                        document.getElementById("boton-editar").addEventListener("click", () => {
                            window.location.href = `editar-musica.html?id=${cancion.id}`;
                        })
                        document.getElementById("boton-borrar").addEventListener("click", async () => {
                            if(confirm("Seguro que queres borrar la cancion?")) {
                                const resBorrar = await fetch(`http://localhost:3000/canciones/${cancion_id}`, {method: "DELETE"});

                                if(resBorrar.ok){
                                    alert("Cancion fue borrada.");
                                    window.location.href = "lista-canciones.html";
                                } 
                                else {
                                    alert("No se pudo borrar la cancion.");
                                }
                                
                            }
                        })
                    }
                
                } 
                catch {
                    alert("Esa cancion no es valida.");
                    window.location.href = "lista-canciones.html";
                    return;
            }
            }
        
            cargarMusica();
        </script>
    </body>
</html>
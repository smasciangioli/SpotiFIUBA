<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>SpotiFIUBA</title>
        <link rel="stylesheet" href="styles/styles.css">
    </head>
    <body>
        <div class="barra-login no-logueado" id="barra-login">
            <h2 class = "azul"> Playlists </h2>
            <br>
    

            <button class="boton-barra" id="boton-login"
                onclick="window.location.href='iniciar-sesion.html'">
                Iniciar sesión
            </button>

            <button class="boton-barra" id="boton-playlist"
                onclick="window.location.href='new-playlist.html'">
                Agregar playlist
            </button>
        </div>
        <header>
            <div class="logo-spotifiuba" onclick="window.location.href='index.html'">
                <span class="negro">Spoti</span><span class="blanco">FIUBA</span><span class="tooltip">Ir a la Página Principal</span>
            </div>
            <div class="botones-header">
                <button class="boton-header" id="boton-iniciar-sesion" onclick="window.location.href='iniciar-sesion.html'">Iniciar Sesión<span class="tooltip">Ir a Iniciar Sesión</span></button>
                <button class="boton-header" id="boton-crear-usuario" onclick="window.location.href='crear-usuario.html'">Crear Usuario<span class="tooltip">Ir a Crear Usuario</span></button>
                <button class="boton-header" id="boton-perfil" onclick="window.location.href='usuario.html'">Perfil</button>
            </div>
        </header>
        <div class="saludo">
            <p>Bienvenido a Spoti<span class = "azul">FIUBA</span></p>
            <hr class="separador">
        </div>
        <div id="boton-musica">
            <button id="subir-musica"><h2>+</h2><span class="tooltip">Ir a Subir Música</span></button>
        </div>
        <div class="botones-acciones">
            <button class="boton-subir" id="boton-lista-playlists">Mis Playlists</button>
            <button class="boton-subir" id="boton-lista-canciones" onclick="window.location.href='lista-canciones.html'">Canciones</button>    
        </div>
        <script>
            let usuario = null
            async function validarLogin() {
                usuario = JSON.parse(localStorage.getItem("usuario"));

                if (!usuario) {
                    actualizarPagina(null);
                    return;
                }

                try {
                    const res = await fetch(`http://localhost:3000/usuarios/${usuario.id}`)

                    if(!res.ok){
                        localStorage.clear();
                        actualizarPagina(null);
                        return;
                    }

                    actualizarPagina(usuario);

                } catch (fallo){
                    console.error(fallo);
                    localStorage.clear();
                    actualizarPagina(null);
                }
            }

            function actualizarPagina(usuario){
                const barra = document.getElementById("barra-login");
                const botonLogin = document.getElementById("boton-login");
                const botonPlaylist = document.getElementById("boton-playlist");
                const botonPerfil = document.getElementById("boton-perfil");
                const botonIniciarSesion = document.getElementById("boton-iniciar-sesion");
                const botonCrearUsuario = document.getElementById("boton-crear-usuario");
                const botonListaPlaylists = document.getElementById("boton-lista-playlists");
                const botonCanciones = document.getElementById("boton-lista-canciones");
                const botonMusica = document.getElementById("boton-musica");

                if (usuario) {
                    botonLogin.style.display = "none";
                    botonPlaylist.style.display = "block";
                    botonPerfil.style.display = "block";
                    botonIniciarSesion.style.display = "none";
                    botonCrearUsuario.style.display = "none";
                    botonListaPlaylists.style.display = "block";
                    botonCanciones.style.display = "block";
                    botonMusica.style.display = "block";
                    
                        
                } else {
                    botonLogin.style.display = "block";
                    botonPlaylist.style.display = "none";
                    botonPerfil.style.display = "none";
                    botonIniciarSesion.style.display = "block";
                    botonCrearUsuario.style.display = "block";
                    botonListaPlaylists.style.display = "none";
                    botonCanciones.style.display = "none";
                    botonMusica.style.display = "none";
                }

                botonListaPlaylists.addEventListener("click", () => {
                    window.location.href = `lista-playlists.html?=${usuario.id}`;
                })
            }

            validarLogin();
            const botonSubirMusica = document.getElementById("subir-musica");
            botonSubirMusica.addEventListener("click", () => {
                if(usuario) {
                    window.location.href = "new-music.html";
                } else {
                    alert("Tenes que crear una cuenta o iniciar sesion.");
                }
                
            })

        </script>
        
    </body>
</html>
